---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# harmBounds

<!-- badges: start -->
[![R-CMD-full](https://github.com/CTU-Bern/harmBounds/workflows/R-CMD-full/badge.svg)](https://github.com/CTU-Bern/harmBounds/actions)
[![R-CMD-standard](https://github.com/CTU-Bern/harmBounds/workflows/R-CMD-standard/badge.svg)](https://github.com/CTU-Bern/harmBounds/actions)
<!-- badges: end -->

The harmBounds package calculates boundaries, simulates data and generates plots for safety monitoring using an event based approach.

The idea is to do simple one sample binomial exact tests on the proportion of events in the experimental arm.

A safety problem is claimed if there is evidence that this is higher than what would be expected
 from the number of people under observation in the two arms (e.g. 0.5 in a 1:1 randomized trial). 
 
This can be done continuously or at pre-specified total number of events.The nominal test-wise alpha would be calibrated to obtain desired properties, such as a certain proportion of stopping under null and alternative scenarios
	or an overall type I error control (which we do not necessarily recommend for safety testing).
	

## Installation

It can be installed from [GitHub](https://github.com/) with:

```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("CTU-Bern/harmBounds")
```

```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE}
devtools::load_all()
```

## Example

### Boundaries

To get boundaries, e.g. for a trial with 3 safety interim analyses after 10, 50 and 100 events (in total over both groups)
  using a nominal test-wise alpha of 0.025.

```{r}
hb<-getHarmBound(nevents=c(10,50,100), alpha_test = 0.025, pH0 = 0.5)
hb
```

'n_treat' indicates the minimal number of events in the treatment group that would lead to a stopping of the trial.
The overall type I error is `r round(hb$cumStopProb[nrow(hb)]*100,1)`%.

If we would like to control the type I error at a specific level, We can get the test-wise alpha using:

```{r}
alphaPerTest <- getAlphaPerTest(nevents = c(10,50,100), pH0= 0.5, totalAlpha = 0.05)

alphaPerTest

getHarmBound(nevents=c(10,50,100), alpha_test = alphaPerTest, pH0 = 0.5)
```

The overall type I error is `r round(hb$cumStopProb[nrow(hb)]*100,1)`%, i.e. as close to 5% as possible (given the discrete nature of the test).


### Simulation

To simulate data under the null hypothesis (H0) and an alternative with 80% events in the experimental arm (H1).

```{r}
set.seed(123)

sim_safety_stop(nevents = c(10,50,100), pH1 = 0.5, alpha_test = 0.025)

sim_safety_stop(nevents = c(10,50,100), pH1 = 0.6, alpha_test = 0.025)
```

And repeat that to get the proportion of trials with a stop (more simulations would be necessary to get precise results)

```{r}

set.seed(123)

ssp0<-vapply(1:100,
	function(x) sim_safety_stop(nevents = c(10,50,100), pH0 = 0.5, pH1 = 0.5,
		alpha_test=0.025)$nstop,
	numeric(1))

mean(ssp0>0)

ssp1<-vapply(1:100,
	function(x) sim_safety_stop(nevents = c(10,50,100), pH0 = 0.5, pH1 = 0.6,
		alpha_test=0.025)$nstop,
	numeric(1))

mean(ssp1>0)

```
We would stop in `r round(100*mean(ssp0>0),1)`% of the trials under the null (no safety problem) and in `r round(100*mean(ssp1>0),1)`% under the alternative (safety problem).


We could now use different test-wise alphas to define an overall design with desired properties, i.e. enough stopping under the alternative while not stopping too often under the null.


